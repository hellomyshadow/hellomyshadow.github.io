<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="NodeJs,">










<meta name="description" content="Koa2.x1. Koa是基于Node.js的下一代web开发框架，也是由Express团队开发的；     1. Node.js是一个异步的世界，官方API支持的都是callback形式的异步编程模型；     2. Koa的开发思路与Express差不多，最大的特点就是，可以避免异步嵌套(回调地狱)；     3. Koa不在内核方法中绑定任何中间件，仅仅提供一个轻量优雅的函数库，所以体积更小">
<meta name="keywords" content="NodeJs">
<meta property="og:type" content="article">
<meta property="og:title" content="Koa-1">
<meta property="og:url" content="http://yoursite.com/2018/08/15/Koa-1/index.html">
<meta property="og:site_name" content="大麦田程序猿">
<meta property="og:description" content="Koa2.x1. Koa是基于Node.js的下一代web开发框架，也是由Express团队开发的；     1. Node.js是一个异步的世界，官方API支持的都是callback形式的异步编程模型；     2. Koa的开发思路与Express差不多，最大的特点就是，可以避免异步嵌套(回调地狱)；     3. Koa不在内核方法中绑定任何中间件，仅仅提供一个轻量优雅的函数库，所以体积更小">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://i.imgur.com/XY2Jw5b.png">
<meta property="og:updated_time" content="2019-01-13T09:53:50.205Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Koa-1">
<meta name="twitter:description" content="Koa2.x1. Koa是基于Node.js的下一代web开发框架，也是由Express团队开发的；     1. Node.js是一个异步的世界，官方API支持的都是callback形式的异步编程模型；     2. Koa的开发思路与Express差不多，最大的特点就是，可以避免异步嵌套(回调地狱)；     3. Koa不在内核方法中绑定任何中间件，仅仅提供一个轻量优雅的函数库，所以体积更小">
<meta name="twitter:image" content="https://i.imgur.com/XY2Jw5b.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/08/15/Koa-1/">





  <title>Koa-1 | 大麦田程序猿</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">大麦田程序猿</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/15/Koa-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="大麦田怪圈">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="大麦田程序猿">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Koa-1</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-15T00:00:00+08:00">
                2018-08-15
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JavaScript/" itemprop="url" rel="index">
                    <span itemprop="name">JavaScript</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="Koa2-x"><a href="#Koa2-x" class="headerlink" title="Koa2.x"></a>Koa2.x</h2><pre><code>1. Koa是基于Node.js的下一代web开发框架，也是由Express团队开发的；
    1. Node.js是一个异步的世界，官方API支持的都是callback形式的异步编程模型；
    2. Koa的开发思路与Express差不多，最大的特点就是，可以避免异步嵌套(回调地狱)；
    3. Koa不在内核方法中绑定任何中间件，仅仅提供一个轻量优雅的函数库，所以体积更小，更健壮
    4. 阿里是业界最早一批使用Node.js做线上大流量应用的公司，并基于koa开发了egg.js
2. 环境搭建：koa2.0开始才算是稳定版，npm install koa --save
    1. koa2.x要求Node.js的版本大于v7.6，因为node7.6开始完全支持async/await
    2. 简单使用：const Koa = require(&apos;koa&apos;);  const app = new Koa();
    app.use( async (ctx)=&gt;{ -----&gt; 配置中间件
        ctx.body = &apos;hello koa2&apos;;
    })
    app.listen(3000, &apos;Ip&apos;) ---&gt; 默认Ip为127.0.0.1
3. koa的工作内容
    1. 接收请求(request) --&gt; 处理数据，生成数据(middleware) --&gt; 发送数据(response)
    2. koa已经处理request和response，开发者只需要专心处理数据即可；
    3. 通过 use() 注册中间件，处理数据、生成数据。
4. 热重载工具：npm i supervisor -g，启动：supervisor app.js
</code></pre><h2 id="四大对象"><a href="#四大对象" class="headerlink" title="四大对象"></a>四大对象</h2><pre><code>1. koa的四大对象：Application -&gt; Context -&gt; Request、Response
2. Application：当前应用程序对象，由 new Koa() 创建的实例对象，Context是其子类；
    let app = new Koa();
    1. app.listen()：启用监听；
    2. app.use(callback)：启用中间件的方法，callback(ctx, next)
    3. ctx 就是 Context对象，next 是迭代器，实现手动控制执行过程；
    4. 异步中间件：use(async(ctx, next) =&gt; { ... });
    5. 监听错误：app.on(&apos;error&apos;, (err, ctx) =&gt; { ...//统计错误处理 });
    app.use((ctx, next) =&gt; {
        throw new Error(); ---&gt; 把错误抛给error事件去处理
    })
3. Context：每次请求都会包装成一个Context对象，它进一步封装了node的request和response
    1. koa把Context传入到中间件函数的第一个参数ctx中；
    2. ctx.req、ctx.res：分别是Node的request对象和response对象(太原始，并不推荐使用)
    3. ctx.request、ctx.response：分别是Koa的request对象和response对象，包含更多信息
    4. ctx.state：用户数据存储空间，ctx.username会污染Context对象，所以用ctx.state
    app.use((ctx, next) =&gt; {
        ctx.state.username = &apos;abc&apos;;
        next();
    }); 
    app.use((ctx, next) =&gt; { --&gt; 同一个请求的Context对象也都是同一个
        console.log(ctx.state.username);
    });
    5. ctx.app：当前应用程序的Application对象
    6. ctx.throw()：抛出错误时不建议使用 throw new Error(); 它属于JS，而throw()带有
    http的错误信息，如抛出404错误：ctx.throw(404, &apos;错误信息&apos;, {附带参数});
4. Request、Response
    1. ctx.request、ctx.response分别获取本次请求的Request对象和Response对象；
    2. Request和Response可以获取/设置本次请求和响应的各种信息；
    3. Request和Response的很多方法会被映射到 Context 上，通过 ctx 直接调用；
    4. 重定向：ctx.redirect(&apos;/login&apos;); --&gt;ctx.response.redirect(&apos;/login&apos;);
    5. 设置下载文件头：ctx.attachment(filename); --&gt;ctx.response.attachment();
    6. ctx.query 同 ctx.request.query，ctx.url 同 ctx.request.url ...
</code></pre><h2 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h2><pre><code>1. 安装路由模块：cnpm install koa-router --save
2. 使用方式：let Router = require(&apos;koa-router&apos;);
    let router = new Router();  ---&gt; 等效于：let router = Router();
    router.get(&apos;/&apos;, async(ctx, next) =&gt; {
        ctx.body = &apos;Index&apos;; ---------&gt; 相当于 res.writeHead();  res.end();
    })
    router.get(&apos;/news&apos;, async(ctx, next) =&gt; {
        ctx.body = &apos;News&apos;;
    }) -----------------------&gt; 可以使用链式调用：router.get().get().get();
    app.use(router.routes());
    app.use(router.allowedMethods());  ----&gt;可以用链式调用，app.use().use();
    1. app.use(router.routes())：启用路由；
    2. app.use(router.allowedMethods())：不是必须，但官方推荐，写在所有路由后面；
    3. allowedMethods() 的作用是会根据 ctx.status 设置response的响应头。
3. router.redict()：路由重定向
    1. router.redict(&apos;/admin&apos;, &apos;/user&apos;, 301);
    2. 访问 /admin 时，会被重定向到 /user
4. URL生成器：Router.url();
    1. Router.url(&apos;/list&apos;, {page: 1}, {query: {order:&apos;desc&apos;}});
    2. 生成路由：/list/1?order=desc
</code></pre><h3 id="参数传递"><a href="#参数传递" class="headerlink" title="参数传递"></a>参数传递</h3><pre><code>1. get传值
    router.get(&apos;/news&apos;, async(ctx, next) =&gt; {
        ctx.body = &apos;News&apos;;
    }) --&gt; http://localhost:3000/news?aid=123&amp;uname=Jack
    1. 接收get传值的方式有两种：query(格式化的参数对象)和querystring(请求字符串)
    2. ctx.query：获取的是参数对象，{ aid:&apos;123&apos;, uname:&apos;Jack&apos; }
    3. ctx.querystring：请求字符串的形式，aid=123&amp;uname=Jack
    4. ctx.url：请求的路由地址，/news?aid=123&amp;uname=Jack
2. 动态路由
    router.get(&apos;/news/:aid&apos;, async(ctx, next) =&gt; {
        ctx.body = &apos;News&apos;;
    }) --&gt; http://localhost:3000/news/123
    1. ctx.params：获取动态路由的参数对象，{ aid: &apos;123&apos; }
    2. /news/:aid/:uname：多个占位符，http://localhost:3000/news/123/Mack
</code></pre><h2 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h2><pre><code>1. 在express中，中间件必须写在所有路由之前，而在koa中不管写在哪个位置，都会优先匹配；
2. 应用级中间件
    app.use(async (ctx)=&gt;{
        ctx.body = &apos;应用级中间件&apos;
    })
    1. 用于匹配所有路由，一旦匹配成功，将不再自动向下匹配；
    2. 手动让路由继续向下匹配
    app.use(async (ctx, next)=&gt;{
        ...
        await next();  ---&gt; 继续向下匹配
    })
3. 路由中间件
    router.get(&apos;/news&apos;, async(ctx, next) =&gt; {
        console.log(&apos;首次匹配news&apos;)
        await next(); ---&gt; 继续向下匹配
    })
    router.get(&apos;/news&apos;, async(ctx, next) =&gt; {
        ctx.body = &apos;News&apos;;
    })
4. 错误处理中间件
    app.use(async (ctx, next)=&gt;{
        console.log(&apos;1&apos;, &apos;中间件&apos;)
        await next(); -----------------&gt;去匹配路由，不会再继续向下执行，等待匹配结果
        console.log(&apos;2&apos;, ctx.url)
        if(ctx.status == 404) { ---&gt; 路由不存在，匹配失败，进行错误处理
            console.log(&apos;3&apos;, &apos;404&apos;)
            ctx.body = &apos;404页面&apos;
        } else { ---------------------&gt; 匹配成功
            console.log(&apos;4&apos;, ctx.url)
        }
    })
    router.get(&apos;/news&apos;, async(ctx, next) =&gt; {
        console.log(&apos;5&apos;, &apos;news&apos;)
        ctx.body = &apos;News&apos;
    })
    1. 访问http://localhost:3000/xxx --&gt; 1 --&gt; 不存在此路由，匹配失败 --&gt; 2 --&gt; 3
    2. 访问http://localhost:3000/news --&gt; 1 --&gt; 5 --&gt; 2 --&gt; 4
5. koa的洋葱模型
    1. koa的匹配过程(request--&gt;response)类似于一个洋葱
</code></pre><p><img src="https://i.imgur.com/XY2Jw5b.png" alt></p>
<pre><code>2. 由外而内，再由内而外：
中间件-1 --&gt; 中间件2 --&gt; 匹配路由，返回匹配结果 --&gt; 中间件2 --&gt; 中间件1
app.use(async(ctx, next)=&gt;{ ----------&gt; 中间件-1
    console.log(&apos;1-1&apos;)
    await next();
    console.log(&apos;1-2&apos;)
})
app.use(async(ctx, next)=&gt;{ ----------&gt; 中间件-2
    console.log(&apos;2-1&apos;)
    await next();
    console.log(&apos;2-2&apos;)
})
router.get(&apos;/news&apos;, async(ctx, next) =&gt; {
    console.log(&apos;news&apos;)
    ctx.body = &apos;News&apos;
})
3. 匹配过程：1-1 ==&gt; 2-1 ==&gt; news ==&gt; 2-2 ==&gt; 1-2
</code></pre><h2 id="POST"><a href="#POST" class="headerlink" title="POST"></a>POST</h2><pre><code>1. 原生NodeJs获取POST提交的数据：&lt;input type=&quot;text&quot; name=&quot;uname&quot; /&gt;
    function parserPost(ctx) {
        return new Promise((resolve, reject) =&gt; {
            try{
                let postData = &quot;&quot;;
                ctx.req.on(&apos;data&apos;, (chunk)=&gt;{
                    postData += chunk.toString();
                });
                ctx.req.on(&apos;end&apos;, ()=&gt;{ ---&gt; 数据传输完成
                    resolve(postData);
                });
            } catch(error) {
                reject(error);
            }
        });
    }
    router.post(&apos;/dologin&apos;, async(ctx) =&gt; {
        let data = await parserPost(ctx);
        ctx.body = &apos;登录成功！&apos;
    })
2. 中间件处理POST提交的数据：npm i koa-bodyparser --save
    1. 配置中间件：let parser = require(&apos;koa-bodyparser&apos;);
    app.use(parser());
    2. 获取post提交的数据
    router.post(&apos;/dologin&apos;, async (ctx)=&gt;{
        let postData = ctx.request.body;
    });
3. 在url中，? 后的内容称为querystring
    1. querystring是url的一部分，与提交方式(无论是post还是get)没有任何关系；
    2. url的长度有限，所以在数据量较大时，不推荐使用querystring的方式传输，跟get没关系；
    3. post请求也可以在url上使用querystring，在后台也可以获取此参数；
    4. 不同的是，get方式不能操作正文，而post可以把参数写入正文(请求体)
</code></pre><h2 id="静态服务"><a href="#静态服务" class="headerlink" title="静态服务"></a>静态服务</h2><pre><code>1. 静态资源中间件：npm install koa-static --save
2. 配置中间件：const static = require(&apos;koa-static&apos;);
    1. app.use(static(&apos;static&apos;)); ----&gt; 托管 根目录/static 下的资源文件
    2. 在模板中访问static/css/base.css：
    &lt;link rel=&quot;stylesheet&quot; href=&quot;css/base.css&quot; /&gt; ---&gt; href=&quot;/css/base.css&quot;
3. koa静态资源的目录也可以配置多个：
    app.use(static(&apos;static&apos;)); ---&gt; 根目录/static
    app.use(static(path(__dirname, &apos;public&apos;))); ---&gt; 根目录/public
    1. 在匹配资源时，会先在static目录下查找，如果查找失败，再去public目录下查找；
    2. app.use(static(&apos;.&apos;)); --&gt;表示去根目录下去查找
    &lt;img src=&quot;public/img/a.png&quot; /&gt; --&gt; 根目录/public/img/a.png
4. app.use(static(&apos;.&apos;))是不安全的，它能访问根目录下的所有资源，如app.js、package.json
</code></pre><h2 id="模板引擎"><a href="#模板引擎" class="headerlink" title="模板引擎"></a>模板引擎</h2><pre><code>适用于koa的模板引擎有很多，如ejs、jade、nunjucks、art-template...
</code></pre><h3 id="koa与ejs"><a href="#koa与ejs" class="headerlink" title="koa与ejs"></a>koa与ejs</h3><pre><code>1. 安装ejs之后，安装koa-views：npm install koa-views --save
2. 多种方式配置koa-views中间件，const views = require(&apos;koa-views&apos;);
    1. app.use(views(&apos;views&apos;, { map:{ html:&apos;ejs&apos; } })); --&gt;模板的后缀名为html
    2. app.use(views(&apos;views&apos;, { extension:&apos;ejs&apos; })); --&gt;模板的后缀名为ejs
    3. views()的第一个参数表示ejs模板存放的目录，&apos;views&apos;表示在根目录/views
3. 在根目录/views中创建index.ejs
    router.get(&apos;/&apos;, async(ctx) =&gt; {
        await ctx.render(&apos;index&apos;, {key: value}) ---&gt;渲染index.ejs
    })
4. 公共数据(全局变量)
    1. 在koa中，通过 ctx.state 管理公共数据，在所有模板中都能访问；
    2. 在中间件中设置公共数据
    app.use(async(ctx, next) =&gt; {
        ctx.state = { uname: &apos;Mack&apos;, age: 20 } ----&gt; 设置公共数据uname和age
        await next();
    })
    3. 在模板中使用：&lt;h2&gt;&lt;%= uname %&gt;&lt;/h2&gt;
</code></pre><h3 id="art-template"><a href="#art-template" class="headerlink" title="art-template"></a>art-template</h3><pre><code>1. art-template是一个简约、超快的模板引擎，它采用作用域预声明的技术来优化模板渲染速度；
    1. art-template的模板渲染速度接近JavaScript极限地运行性能，且同时支持NodeJs和浏览器
    2. art-template支持ejs语法，也可以用类似angular数据绑定地语法
    3. 由腾讯开发的，同时支持Express、Koa
2. 渲染速度：art-template(15-25ms) &gt; jade(51ms) &gt; ejs(141ms)
3. 安装：npm install art-template --save，npm install koa-art-template --save
    const render = require(&apos;koa-art-template&apos;);
    render(app, {
        root: path.join(__dirname, &apos;views&apos;), ---&gt; 配置模板的位置：根目录/view
        extname: &apos;.art&apos;, ---&gt; 模板的扩展名，也可以设置为&apos;.html&apos;
        debug: process.env.NODE_ENV !== &apos;production&apos; --&gt; 开发环境下开启调试模式
    })
    app.use(async (ctx)=&gt;{
        await ctx.render(&apos;index&apos;, {key: value}); --&gt; 根目录/views/index.art
    })
4. art-template支持类似ejs的语法(原始语法)，也支持类似angular的语法(标准语法)
    1. 原始语法：&lt;%= value %&gt;，&lt;%= a?b:c %&gt; ，&lt;%= a+b %&gt;，&lt;%- value %&gt; ...
    2. 引入子模板的方式与ejs不同：&lt;% include(&apos;./public/header.art&apos;) %&gt;
    &lt;% include(&apos;./public/header.art&apos;, data) %&gt;
5. 标准语法：{{value}}，{{a?b:c}}，{{a+b}}，{{@value}}，{{if a}} ... {{/if}}
    1. {{@value}}：表示原样输出value，如value=&quot;&lt;p&gt;123&lt;/p&gt;&quot;，原样输出的结果就是&lt;p&gt;标签
    2. 循环数据：{{each a}}  {{$index}} {{$value}}  {{/each}}
    3. 引入子模板：{{include './header.art'}}，{{include './header.art', data}}
    4. 引入不在同一目录下的子模板时，不能使用相对路径，而是直接相对于模板的根目录；
    {{include 'admin/public/header.html'}}  ---&gt;views/admin/public/header.html
6. 在标签内直接使用模板语言
    &lt;input type=&quot;checkbox&quot; {{if list.check==1}} checked {{/if}} /&gt;
</code></pre><h2 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a>Cookie</h2><pre><code>1. Koa可以直接操作cookie：ctx.cookies.set(name, value, [options])
    router.get(&apos;/&apos;, async (ctx)=&gt;{
        ctx.cookies.set(&apos;uname&apos;, &apos;Jack&apos;, {
            maxAge: 60*1000*60 ---&gt; 60s后过期
        })
    })
    1. 获取cookie：ctx.cookies.get(&apos;uname&apos;)
2. options的可选参数：maxAge、expires、path、domain、secure、httpOnly、overwrite
    1. httpOnly：是否只允许服务器访问cookie，默认为true，不允许浏览器端的JS访问cookie
    2. secure：安全的cookie，默认为false，设置为true表示只允许https可以访问；
    3. overwrite：是否覆盖以前设置的同名cookie，默认为false
    ctx.cookies.set(&apos;uname&apos;, &apos;Jack&apos;, {
        path: &apos;/news&apos;,  ---&gt; 只允许 /news 路由页面可以访问此cookie
        domain: &apos;.baidu.com&apos;  --&gt;设置允许访问cookie的域名，默认当前域名下的所有路由页面
    }) -------------------------&gt; 都可以访问，所以正常情况下不会设置
3. 在koa中无法直接设置中文的cookie，如ctx.cookies.set(&apos;uname&apos;, &apos;李蕾&apos;);
    1. 可以把中文转为base64编码：new Buffer(&apos;李蕾&apos;).toString(&apos;base64&apos;);
    2. 解码：new Buffer(&apos;base64编码数据&apos;, &apos;base64&apos;).toString();
</code></pre><h2 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h2><pre><code>1. 安装中间件：npm i koa-session --save
2. 配置session中间件
    1. const session = require(&apos;koa-session&apos;);
    2. app.keys = [&apos;some secret&apos;]; ---&gt; cookie的签名/加密，可以是任意字符串
    2. app.use(session(CONFIG, app));
3. CONFIG表示session的配置
    const CONFIG = {
        key: &apos;koa:sess&apos;,  ---&gt; 也类似于cookie的key，使用默认配置即可
        maxAge: 86400000, ---&gt; cookie的过期时间
        overwrite: true,
        httpOnly: false,  ---&gt; 默认为true，表示只允许服务器端访问cookie
        signed: true, ----&gt; 启用签名
        rolling: false,
        renew: false
    }
    1. rolling:true --&gt; 浏览器每次访问都强制设置cookie，每次都会重置过期时间
    2. renew:true --&gt; 每次访问时会检查cookie的过期时间，在将要过期时才会重置过期时间
4. 设置/获取：ctx.session.uname=&apos;Mack&apos;;  let uname=ctx.session.uname;
</code></pre><hr>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/NodeJs/" rel="tag"># NodeJs</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/08/01/Express/" rel="next" title="Express">
                <i class="fa fa-chevron-left"></i> Express
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/08/17/Koa-2/" rel="prev" title="Koa-2">
                Koa-2 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">大麦田怪圈</p>
              <p class="site-description motion-element" itemprop="description">敢做就能赢！</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">53</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">34</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Koa2-x"><span class="nav-number">1.</span> <span class="nav-text">Koa2.x</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#四大对象"><span class="nav-number">2.</span> <span class="nav-text">四大对象</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#路由"><span class="nav-number">3.</span> <span class="nav-text">路由</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#参数传递"><span class="nav-number">3.1.</span> <span class="nav-text">参数传递</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#中间件"><span class="nav-number">4.</span> <span class="nav-text">中间件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#POST"><span class="nav-number">5.</span> <span class="nav-text">POST</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#静态服务"><span class="nav-number">6.</span> <span class="nav-text">静态服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#模板引擎"><span class="nav-number">7.</span> <span class="nav-text">模板引擎</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#koa与ejs"><span class="nav-number">7.1.</span> <span class="nav-text">koa与ejs</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#art-template"><span class="nav-number">7.2.</span> <span class="nav-text">art-template</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cookie"><span class="nav-number">8.</span> <span class="nav-text">Cookie</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Session"><span class="nav-number">9.</span> <span class="nav-text">Session</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">大麦田怪圈</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
